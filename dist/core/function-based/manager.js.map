{"version":3,"file":"manager.js","sources":["../../../src/core/function-based/manager.ts"],"sourcesContent":["// @ts-ignore\nimport { createCache, getValue } from '@glimmer/tracking/primitives/cache';\nimport { associateDestroyableChild, destroy, registerDestructor } from '@ember/destroyable';\n// @ts-ignore\nimport { capabilities as helperCapabilities } from '@ember/helper';\n\nimport type { Cache, Destructor, InternalFunctionResourceConfig, ResourceFunction } from './types';\nimport type Owner from '@ember/owner';\n\n/**\n * Note, a function-resource receives on object, hooks.\n *    We have to build that manually in this helper manager\n */\nclass FunctionResourceManager {\n  capabilities = helperCapabilities('3.23', {\n    hasValue: true,\n    hasDestroyable: true,\n  });\n\n  constructor(protected owner: Owner) {}\n\n  /**\n   * Resources do not take args.\n   * However, they can access tracked data\n   */\n  createHelper(config: InternalFunctionResourceConfig) {\n    let { definition: fn } = config;\n    /**\n     * We have to copy the `fn` in case there are multiple\n     * usages or invocations of the function.\n     *\n     * This copy is what we'll ultimately work with and eventually\n     * destroy.\n     */\n    let thisFn = fn.bind(null);\n    let previousFn: object;\n\n    let cache = createCache(() => {\n      if (previousFn) {\n        destroy(previousFn);\n      }\n\n      let currentFn = thisFn.bind(null);\n\n      associateDestroyableChild(thisFn, currentFn);\n      previousFn = currentFn;\n\n      let maybeValue = currentFn({\n        on: {\n          cleanup: (destroyer: Destructor) => {\n            registerDestructor(currentFn, destroyer);\n          },\n        },\n        owner: this.owner,\n      });\n\n      return maybeValue;\n    });\n\n    return { fn: thisFn, cache };\n  }\n\n  getValue({ cache }: { fn: ResourceFunction; cache: Cache }) {\n    let maybeValue = getValue(cache);\n\n    if (typeof maybeValue === 'function') {\n      return maybeValue();\n    }\n\n    return maybeValue;\n  }\n\n  getDestroyable({ fn }: { fn: ResourceFunction }) {\n    return fn;\n  }\n}\n\nexport const ResourceManagerFactory = (owner: Owner) => new FunctionResourceManager(owner);\n"],"names":["FunctionResourceManager","constructor","owner","_defineProperty","helperCapabilities","hasValue","hasDestroyable","createHelper","config","definition","fn","thisFn","bind","previousFn","cache","createCache","destroy","currentFn","associateDestroyableChild","maybeValue","on","cleanup","destroyer","registerDestructor","getValue","getDestroyable","ResourceManagerFactory"],"mappings":";;;;;AASA;AACA;AACA;AACA;AACA,MAAMA,uBAAuB,CAAC;EAM5BC,WAAWA,CAAWC,KAAY,EAAE;AAAAC,IAAAA,eAAA,CALrBC,IAAAA,EAAAA,cAAAA,EAAAA,YAAkB,CAAC,MAAM,EAAE;AACxCC,MAAAA,QAAQ,EAAE,IAAI;AACdC,MAAAA,cAAc,EAAE,IAAA;AAClB,KAAC,CAAC,CAAA,CAAA;IAAA,IAEoBJ,CAAAA,KAAY,GAAZA,KAAY,CAAA;AAAG,GAAA;;AAErC;AACF;AACA;AACA;EACEK,YAAYA,CAACC,MAAsC,EAAE;IACnD,IAAI;AAAEC,MAAAA,UAAU,EAAEC,EAAAA;AAAG,KAAC,GAAGF,MAAM,CAAA;AAC/B;AACJ;AACA;AACA;AACA;AACA;AACA;AACI,IAAA,IAAIG,MAAM,GAAGD,EAAE,CAACE,IAAI,CAAC,IAAI,CAAC,CAAA;AAC1B,IAAA,IAAIC,UAAkB,CAAA;AAEtB,IAAA,IAAIC,KAAK,GAAGC,WAAW,CAAC,MAAM;AAC5B,MAAA,IAAIF,UAAU,EAAE;QACdG,OAAO,CAACH,UAAU,CAAC,CAAA;AACrB,OAAA;AAEA,MAAA,IAAII,SAAS,GAAGN,MAAM,CAACC,IAAI,CAAC,IAAI,CAAC,CAAA;AAEjCM,MAAAA,yBAAyB,CAACP,MAAM,EAAEM,SAAS,CAAC,CAAA;AAC5CJ,MAAAA,UAAU,GAAGI,SAAS,CAAA;MAEtB,IAAIE,UAAU,GAAGF,SAAS,CAAC;AACzBG,QAAAA,EAAE,EAAE;UACFC,OAAO,EAAGC,SAAqB,IAAK;AAClCC,YAAAA,kBAAkB,CAACN,SAAS,EAAEK,SAAS,CAAC,CAAA;AAC1C,WAAA;SACD;QACDpB,KAAK,EAAE,IAAI,CAACA,KAAAA;AACd,OAAC,CAAC,CAAA;AAEF,MAAA,OAAOiB,UAAU,CAAA;AACnB,KAAC,CAAC,CAAA;IAEF,OAAO;AAAET,MAAAA,EAAE,EAAEC,MAAM;AAAEG,MAAAA,KAAAA;KAAO,CAAA;AAC9B,GAAA;AAEAU,EAAAA,QAAQA,CAAC;AAAEV,IAAAA,KAAAA;AAA8C,GAAC,EAAE;AAC1D,IAAA,IAAIK,UAAU,GAAGK,QAAQ,CAACV,KAAK,CAAC,CAAA;AAEhC,IAAA,IAAI,OAAOK,UAAU,KAAK,UAAU,EAAE;AACpC,MAAA,OAAOA,UAAU,EAAE,CAAA;AACrB,KAAA;AAEA,IAAA,OAAOA,UAAU,CAAA;AACnB,GAAA;AAEAM,EAAAA,cAAcA,CAAC;AAAEf,IAAAA,EAAAA;AAA6B,GAAC,EAAE;AAC/C,IAAA,OAAOA,EAAE,CAAA;AACX,GAAA;AACF,CAAA;AAEO,MAAMgB,sBAAsB,GAAIxB,KAAY,IAAK,IAAIF,uBAAuB,CAACE,KAAK;;;;"}