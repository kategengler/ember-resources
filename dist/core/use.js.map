{"version":3,"file":"use.js","sources":["../../src/core/use.ts"],"sourcesContent":["// @ts-ignore\nimport { getValue } from '@glimmer/tracking/primitives/cache';\nimport { assert } from '@ember/debug';\nimport { associateDestroyableChild } from '@ember/destroyable';\n// @ts-ignore\nimport { invokeHelper } from '@ember/helper';\n\nimport { INTERNAL } from './function-based/types';\nimport { normalizeThunk } from './utils';\n\nimport type { InternalFunctionResourceConfig } from './function-based/types';\nimport type { Thunk } from '[core-types]';\n\ninterface Descriptor {\n  initializer: () => unknown;\n}\n\ninterface ClassResourceConfig {\n  thunk: Thunk;\n  definition: unknown;\n  type: 'class-based';\n  [INTERNAL]: true;\n}\n\ntype Config = ClassResourceConfig | InternalFunctionResourceConfig;\n\n/**\n * The `@use` decorator has two responsibilities\n *    - abstract away the underlying reactivity configuration (invokeHelper)\n *       - by doing this, we get destruction-association properly configured so that\n *         when the host class is destroyed, if the resource has a destructor, it\n *         will be called during destruction\n *    - allows the return value of the resource to be \"the\" value of the property.\n *\n *\n * This `@use` decorator is needed for function-resources, and *not* needed for class-based\n * resources (for now).\n *\n * @example\n * ```js\n * import { resource, use } from 'ember-resources';\n *\n * class MyClass {\n *   @use data = resource(() => {\n *     return 2;\n *   });\n * }\n *\n * (new MyClass()).data === 2\n * ```\n */\nexport function use(_prototype: object, key: string, descriptor?: Descriptor): void {\n  if (!descriptor) return;\n\n  assert(`@use can only be used with string-keys`, typeof key === 'string');\n\n  let caches = new WeakMap<object, any>();\n\n  let { initializer } = descriptor;\n\n  assert(\n    `@use may only be used on initialized properties. For example, ` +\n      `\\`@use foo = resource(() => { ... })\\` or ` +\n      `\\`@use foo = SomeResource.from(() => { ... });\\``,\n    initializer\n  );\n\n  // https://github.com/pzuraq/ember-could-get-used-to-this/blob/master/addon/index.js\n  return {\n    get(this: object) {\n      let cache = caches.get(this);\n\n      if (!cache) {\n        let config = initializer.call(this) as Config;\n\n        assert(\n          `Expected initialized value under @use to have used either the \\`resource\\` wrapper function, or a \\`Resource.from\\` call`,\n          INTERNAL in config\n        );\n\n        if (config.type === 'function-based') {\n          cache = invokeHelper(this, config);\n          caches.set(this as object, cache);\n          associateDestroyableChild(this, cache);\n        } else if (config.type === 'class-based') {\n          let { definition, thunk } = config;\n\n          cache = invokeHelper(this, definition, () => normalizeThunk(thunk));\n          caches.set(this as object, cache);\n          associateDestroyableChild(this, cache);\n        }\n\n        assert(`Failed to create cache for internal resource configuration object`, cache);\n      }\n\n      return getValue(cache);\n    },\n  } as unknown as void /* Thanks TS. */;\n}\n"],"names":["use","_prototype","key","descriptor","assert","caches","WeakMap","initializer","get","cache","config","call","INTERNAL","type","invokeHelper","set","associateDestroyableChild","definition","thunk","normalizeThunk","getValue"],"mappings":";;;;;;;AAAA;AA0BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,GAAGA,CAACC,UAAkB,EAAEC,GAAW,EAAEC,UAAuB,EAAQ;EAClF,IAAI,CAACA,UAAU,EAAE,OAAA;AAEjBC,EAAAA,MAAM,CAAE,CAAuC,sCAAA,CAAA,EAAE,OAAOF,GAAG,KAAK,QAAQ,CAAC,CAAA;AAEzE,EAAA,IAAIG,MAAM,GAAG,IAAIC,OAAO,EAAe,CAAA;EAEvC,IAAI;AAAEC,IAAAA,WAAAA;AAAY,GAAC,GAAGJ,UAAU,CAAA;EAEhCC,MAAM,CACH,gEAA+D,GAC7D,CAAA,0CAAA,CAA2C,GAC3C,CAAiD,gDAAA,CAAA,EACpDG,WAAW,CACZ,CAAA;;AAED;EACA,OAAO;AACLC,IAAAA,GAAGA,GAAe;AAChB,MAAA,IAAIC,KAAK,GAAGJ,MAAM,CAACG,GAAG,CAAC,IAAI,CAAC,CAAA;MAE5B,IAAI,CAACC,KAAK,EAAE;AACV,QAAA,IAAIC,MAAM,GAAGH,WAAW,CAACI,IAAI,CAAC,IAAI,CAAW,CAAA;AAE7CP,QAAAA,MAAM,CACH,CAAyH,wHAAA,CAAA,EAC1HQ,QAAQ,IAAIF,MAAM,CACnB,CAAA;AAED,QAAA,IAAIA,MAAM,CAACG,IAAI,KAAK,gBAAgB,EAAE;AACpCJ,UAAAA,KAAK,GAAGK,YAAY,CAAC,IAAI,EAAEJ,MAAM,CAAC,CAAA;AAClCL,UAAAA,MAAM,CAACU,GAAG,CAAC,IAAI,EAAYN,KAAK,CAAC,CAAA;AACjCO,UAAAA,yBAAyB,CAAC,IAAI,EAAEP,KAAK,CAAC,CAAA;AACxC,SAAC,MAAM,IAAIC,MAAM,CAACG,IAAI,KAAK,aAAa,EAAE;UACxC,IAAI;YAAEI,UAAU;AAAEC,YAAAA,KAAAA;AAAM,WAAC,GAAGR,MAAM,CAAA;AAElCD,UAAAA,KAAK,GAAGK,YAAY,CAAC,IAAI,EAAEG,UAAU,EAAE,MAAME,cAAc,CAACD,KAAK,CAAC,CAAC,CAAA;AACnEb,UAAAA,MAAM,CAACU,GAAG,CAAC,IAAI,EAAYN,KAAK,CAAC,CAAA;AACjCO,UAAAA,yBAAyB,CAAC,IAAI,EAAEP,KAAK,CAAC,CAAA;AACxC,SAAA;AAEAL,QAAAA,MAAM,CAAE,CAAA,iEAAA,CAAkE,EAAEK,KAAK,CAAC,CAAA;AACpF,OAAA;MAEA,OAAOW,QAAQ,CAACX,KAAK,CAAC,CAAA;AACxB,KAAA;AACF,GAAC,kBAAoB;AACvB;;;;"}